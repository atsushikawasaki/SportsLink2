name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ ã‚¨ãƒ©ãƒ¼ç¢ºèª â†’ è‡ªå‹•ä¿®æ­£ â†’ å†ãƒ†ã‚¹ãƒˆ

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-and-fix:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: sportslink-app/package-lock.json

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        working-directory: ./sportslink-app
        run: npm ci

      - name: åˆå›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        id: first_test
        working-directory: ./sportslink-app
        continue-on-error: true
        run: |
          npm run test 2>&1 | tee test-output.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
        id: lint_check
        working-directory: ./sportslink-app
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint-output.log
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: ã‚¨ãƒ©ãƒ¼ç¢ºèªã¨è‡ªå‹•ä¿®æ­£
        working-directory: ./sportslink-app
        if: steps.lint_check.outputs.exit_code != '0'
        run: |
          echo "ğŸ”§ ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡ºã€‚è‡ªå‹•ä¿®æ­£ã‚’è©¦ã¿ã¾ã™..."
          npm run lint -- --fix || true
          echo "âœ… è‡ªå‹•ä¿®æ­£å®Œäº†"

      - name: è‡ªå‹•ä¿®æ­£å¾Œã®å†ãƒ†ã‚¹ãƒˆ
        working-directory: ./sportslink-app
        if: steps.first_test.outputs.exit_code != '0' || steps.lint_check.outputs.exit_code != '0'
        run: |
          echo "ğŸ”„ è‡ªå‹•ä¿®æ­£å¾Œã®å†ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™..."
          npm run test || true
          npm run lint || true

      - name: ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆ
        if: always()
        working-directory: ./sportslink-app
        run: |
          echo "## ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åˆå›ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          if [ -f test-output.log ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 test-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ãƒªãƒ³ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
          if [ -f lint-output.log ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 lint-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
        if: always()
        working-directory: ./sportslink-app
        run: |
          npm run test:coverage || true
          echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ"

      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            sportslink-app/test-output.log
            sportslink-app/lint-output.log
            sportslink-app/coverage/

      - name: æœ€çµ‚ãƒã‚§ãƒƒã‚¯
        working-directory: ./sportslink-app
        run: |
          echo "ğŸ” æœ€çµ‚ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™..."
          npm run test
          npm run lint

