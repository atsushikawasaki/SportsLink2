# Sport Link 完全要件定義書

## 1. プロジェクト概要

### 1.1 システム名

Sport Link（ソフトテニス大会運営支援システム）

### 1.2 目的

ソフトテニス競技におけるスコア記録・分析および大会運営を支援するシステム。リアルタイムスコアリング、オフライン対応、マルチロール対応、観戦者向け公開といった大会実用性を重視したPWAアプリケーション。

### 1.3 主要機能

- リアルタイムスコアリング（500ms以内反映）
- オフライン対応（PWA + IndexedDB）
- 競合解決（409 Conflict処理）
- RBAC権限管理（RLS）
- 監査ログ（5年間保持）
- 大会管理・ドロー生成
- エントリー管理（CSVインポート/エクスポート）
- ペア管理
- 試合割当管理

## 2. 技術スタック

### 2.1 フロントエンド

- Next.js 14.2.35（フレームワーク、App Router）
- React 18 + TypeScript 5
- PWA（Service Worker + IndexedDB via Dexie 4.2.1）
- Tailwind CSS 3.4.1
- Zustand 5.0.9（状態管理）
- React Hook Form 7.69.0 + Zod 4.2.1（フォーム管理）
- Supabase Client SDK 2.78.0（@supabase/ssr 0.8.0）
- Lucide React 0.562.0（アイコン）
- React Query 5.90.15（データフェッチング）
- React Markdown 9.0.1（Markdown表示）

### 2.2 バックエンド

- Next.js API Routes（サーバーサイドAPI）
- PostgreSQL 15.1.0（Supabase）
- Supabase JS SDK 2.78.0（@supabase/ssr 0.8.0）
- Supabase Auth（認証）
- Bcryptjs 3.0.3（パスワードハッシュ）
- Zod 4.2.1（バリデーション）

### 2.3 インフラ

- Supabase（PostgreSQL + Realtime + Auth）
- Docker & Docker Compose
- Nginx（フロントエンド配信）

### 2.4 ブラウザサポート

- Chrome/Edge: 最新版（PWA対応）
- Safari: iOS 14.0以上、macOS 11.0以上（PWA対応）
- Firefox: 最新版（PWA対応）
- モバイル: iOS Safari、Android Chrome（PWA対応）

## 3. データベーススキーマ

### 3.1 テーブル一覧

#### Users（ユーザー）

- id: UUID (PK)
- email: TEXT (UNIQUE)
- display_name: TEXT
- password_hash: TEXT (bcryptハッシュ、NULLの場合は認証不可)
- master_flag: BOOLEAN (DEFAULT FALSE)
- master_manager_flag: BOOLEAN (DEFAULT FALSE)
- umpire_flag: BOOLEAN (DEFAULT FALSE)
- team_manager_flag: BOOLEAN (DEFAULT FALSE)
- created_at: TIMESTAMPTZ (DEFAULT now())

#### Tournaments（大会）

- id: UUID (PK)
- name: TEXT (NOT NULL)
- status: TEXT ('draft' | 'published' | 'finished', DEFAULT 'draft')
- is_public: BOOLEAN (DEFAULT FALSE)
- description: TEXT (オプション)
- start_date: DATE (オプション)
- end_date: DATE (オプション)
- match_format: TEXT ('team_doubles_3' | 'team_doubles_4_singles_1' | 'individual_doubles' | 'individual_singles', オプション)
- umpire_mode: TEXT ('LOSER' | 'ASSIGNED' | 'FREE', DEFAULT 'LOSER')
  - LOSER: 敗者審判モード（前試合の敗者が審判を担当）
  - ASSIGNED: 運営割当モード（運営が指名した審判のみ入力可能）
  - FREE: フリーモード（誰でも入力可能、練習試合等）
- created_by_user_id: UUID (FK → Users, NOT NULL)
- created_at: TIMESTAMPTZ (DEFAULT now())

#### UserRoles（ユーザーロール）

- user_id: UUID (FK → Users)
- tournament_id: UUID (FK → Tournaments)
- role: TEXT ('tournament_admin' | 'scorer')
- created_at: TIMESTAMPTZ
- PRIMARY KEY (user_id, tournament_id)

#### Teams（チーム）

- id: UUID (PK)
- tournament_id: UUID (FK → Tournaments, NOT NULL)
- name: TEXT (NOT NULL)
- school_name: TEXT (NOT NULL)
- description: TEXT (オプション)
- team_manager_user_id: UUID (FK → Users, オプション)
- created_at: TIMESTAMPTZ (DEFAULT now())

#### Tournament_Teams（大会-チーム関連）

- tournament_id: UUID (FK → Tournaments)
- team_id: UUID (FK → Teams)
- PRIMARY KEY (tournament_id, team_id)

#### Tournament_Players（大会参加選手）

- id: UUID (PK)
- tournament_id: UUID (FK → Tournaments)
- team_id: UUID (FK → Teams)
- player_name: TEXT
- player_type: TEXT ('前衛' | '後衛' | '両方')
- created_at: TIMESTAMPTZ

#### Matches（試合）

- id: UUID (PK)
- tournament_id: UUID (FK → Tournaments, NOT NULL)
- phase_id: UUID (FK → Tournament_Phases, オプション)
- round_name: TEXT (NOT NULL)
- round_index: SMALLINT (オプション)
- slot_index: SMALLINT (オプション)
- match_number: INTEGER (オプション)
- umpire_id: UUID (FK → Users, NOT NULL)
- court_number: INTEGER (オプション)
- status: TEXT ('pending' | 'inprogress' | 'finished', DEFAULT 'pending')
- version: INTEGER (楽観的ロック用, DEFAULT 1)
- winner_next_match_id: UUID (FK → Matches, オプション)
- winner_next_slot: SMALLINT (オプション)
- loser_next_match_id: UUID (FK → Matches, オプション)
- loser_next_slot: SMALLINT (オプション)
- started_at: TIMESTAMPTZ (オプション)
- created_at: TIMESTAMPTZ (DEFAULT now())

#### Match_Pairs（試合の対戦ペア）

- id: UUID (PK)
- match_id: UUID (FK → Matches, NOT NULL)
- pair_number: INTEGER (NOT NULL)
- team_id: UUID (FK → Teams, NOT NULL)
- player_1_id: UUID (FK → Tournament_Players, NOT NULL)
- player_2_id: UUID (FK → Tournament_Players, NULL可 - シングルスの場合はNULL)
- created_at: TIMESTAMPTZ (DEFAULT now())
- 制約: player_2_idがNULLの場合はシングルス、NULLでない場合はplayer_1_id != player_2_id

#### Points（ポイント記録）

- id: UUID (PK)
- match_id: UUID (FK → Matches)
- point_type: TEXT ('A_score' | 'B_score')
- client_uuid: UUID
- server_received_at: TIMESTAMPTZ
- is_undone: BOOLEAN
- created_at: TIMESTAMPTZ

#### Match_Scores（試合スコア）

- match_id: UUID (PK, FK → Matches)
- game_count_a: INTEGER (DEFAULT 0)
- game_count_b: INTEGER (DEFAULT 0)
- final_score: TEXT (オプション)
- updated_at: TIMESTAMPTZ (DEFAULT now())
- 注意: current_game_score_a/bは計算値であり、テーブルには保存されない

#### Audit_Logs（監査ログ）

- id: UUID (PK)
- table_name: TEXT
- operation_type: TEXT ('INSERT' | 'UPDATE' | 'DELETE')
- record_id: UUID
- old_data: JSONB
- new_data: JSONB
- performed_by: UUID (FK → Users)
- performed_at: TIMESTAMPTZ

#### Tournament_Phases（大会フェーズ）

- id: UUID (PK)
- tournament_id: UUID (FK → Tournaments)
- phase_type: TEXT ('tournament' | 'league')
- name: TEXT
- sequence: INTEGER
- config: JSONB

#### Tournament_Pairs（大会ペアエントリー）

- id: UUID (PK)
- tournament_id: UUID (FK → Tournaments, NOT NULL)
- team_id: UUID (FK → Teams, オプション - 団体戦の場合は必須、個人戦の場合はNULL)
- pair_number: INTEGER (NOT NULL)
- player_1_id: UUID (FK → Tournament_Players, NOT NULL)
- player_2_id: UUID (FK → Tournament_Players, NULL可 - ダブルスの場合は必須、シングルスの場合はNULL)
- created_at: TIMESTAMPTZ (DEFAULT now())
- UNIQUE制約: (tournament_id, team_id, pair_number) - 団体戦の場合、同じチーム内で同じペア番号は不可
- 制約: player_2_idがNULLの場合はシングルス、NULLでない場合はplayer_1_id != player_2_id

#### Tournament_Phases（大会フェーズ）

- id: UUID (PK)
- tournament_id: UUID (FK → Tournaments, NOT NULL)
- phase_type: TEXT ('tournament' | 'league', NOT NULL)
- name: TEXT (NOT NULL)
- sequence: SMALLINT (NOT NULL)
- config: JSONB (DEFAULT '{}'::jsonb)
- created_at: TIMESTAMPTZ (DEFAULT now())
- UNIQUE制約: (tournament_id, sequence)

#### Tournament_Groups（大会グループ - リーグ戦用）

- id: UUID (PK)
- phase_id: UUID (FK → Tournament_Phases, NOT NULL)
- name: TEXT (NOT NULL)
- seed_bucket: TEXT (オプション)
- config: JSONB (DEFAULT '{}'::jsonb)
- created_at: TIMESTAMPTZ (DEFAULT now())

#### Tournament_Entries（大会エントリー - 統一エントリー抽象化）

- id: UUID (PK)
- tournament_id: UUID (FK → Tournaments, NOT NULL)
- entry_type: TEXT ('team' | 'pair', NOT NULL)
- team_id: UUID (FK → Teams, オプション - entry_type='team'の場合は必須)
- pair_id: UUID (FK → Tournament_Pairs, オプション - entry_type='pair'の場合は必須)
- seed_rank: SMALLINT (オプション)
- performance_score: INTEGER (オプション)
- team_order: SMALLINT (オプション)
- affiliation_key: TEXT (オプション)
- is_active: BOOLEAN (DEFAULT TRUE)
- is_checked_in: BOOLEAN (DEFAULT FALSE)
  - 当日受付（チェックイン）の完了状態
- day_token: VARCHAR(4)
  - 認証キー（4桁の数字、チェックイン時に発行）
  - 大会終了まで有効なトークン
- last_checked_in_at: TIMESTAMPTZ (オプション)
  - 最終チェックイン日時
- created_at: TIMESTAMPTZ (DEFAULT now())
- 制約: entry_type='team'の場合はteam_id必須、pair_id=NULL。entry_type='pair'の場合はpair_id必須
- UNIQUE制約: team_id（team_id IS NOT NULLの場合）、pair_id（pair_id IS NOT NULLの場合）

#### Match_Slots（試合スロット - ドロー構造用）

- id: UUID (PK)
- match_id: UUID (FK → Matches, NOT NULL)
- slot_number: SMALLINT (1 or 2, NOT NULL)
- source_type: TEXT ('entry' | 'winner' | 'loser' | 'bye', NOT NULL)
- seed_position: SMALLINT (オプション)
- entry_id: UUID (FK → Tournament_Entries, オプション - source_type='entry'の場合は必須)
- source_match_id: UUID (FK → Matches, オプション - source_type='winner'/'loser'の場合は必須)
- placeholder_label: TEXT (オプション)
- created_at: TIMESTAMPTZ (DEFAULT now())
- UNIQUE制約: (match_id, slot_number)
- 制約: source_type='entry'の場合はentry_id必須、source_match_id=NULL。source_type='winner'/'loser'の場合はsource_match_id必須。source_type='bye'の場合は両方NULL

#### User_Consents（ユーザー同意ログ）

- id: UUID (PK)
- user_id: UUID (FK → Users, NOT NULL)
- consent_type: TEXT ('terms' | 'privacy', NOT NULL)
- version: TEXT (規約・ポリシーのバージョン番号, NOT NULL)
- agreed_at: TIMESTAMPTZ (同意日時, DEFAULT now())
- ip_address: TEXT (オプション、同意時のIPアドレス)
- user_agent: TEXT (オプション、同意時のユーザーエージェント)
- created_at: TIMESTAMPTZ (DEFAULT now())

#### Contact_Requests（問い合わせ）

- id: UUID (PK)
- user_id: UUID (FK → Users, オプション - ログインユーザーの場合)
- category: TEXT ('technical' | 'feature' | 'other', NOT NULL)
- email: TEXT (NOT NULL)
- subject: TEXT (NOT NULL)
- message: TEXT (NOT NULL)
- status: TEXT ('pending' | 'resolved', DEFAULT 'pending')
- created_at: TIMESTAMPTZ (DEFAULT now())

### 3.2 インデックス

- idx_points_match_id ON Points(match_id)
- idx_points_server_received_at ON Points(server_received_at)
- idx_matches_tournament_id ON Matches(tournament_id)
- idx_matches_umpire_id ON Matches(umpire_id)
- idx_matches_phase_round_slot ON Matches(phase_id, round_index, slot_index)
- idx_user_roles_user_id ON UserRoles(user_id)
- idx_user_roles_tournament_id ON UserRoles(tournament_id)
- idx_audit_logs_performed_by ON Audit_Logs(performed_by)
- idx_audit_logs_performed_at ON Audit_Logs(performed_at)
- idx_tournament_pairs_tournament_id ON Tournament_Pairs(tournament_id)
- idx_tournament_pairs_team_id ON Tournament_Pairs(team_id)
- idx_tournament_pairs_player_1_id ON Tournament_Pairs(player_1_id)
- idx_tournament_pairs_player_2_id ON Tournament_Pairs(player_2_id)
- idx_tournament_phases_sequence ON Tournament_Phases(tournament_id, sequence)
- idx_tournament_phases_tournament_id ON Tournament_Phases(tournament_id)
- idx_tournament_groups_phase_id ON Tournament_Groups(phase_id)
- idx_tournament_entries_tournament_id ON Tournament_Entries(tournament_id)
- idx_tournament_entries_team_unique ON Tournament_Entries(team_id) WHERE team_id IS NOT NULL
- idx_tournament_entries_pair_unique ON Tournament_Entries(pair_id) WHERE pair_id IS NOT NULL
- idx_match_slots_match_id ON Match_Slots(match_id)
- idx_match_slots_entry_id ON Match_Slots(entry_id) WHERE entry_id IS NOT NULL
- idx_match_slots_source_match_id ON Match_Slots(source_match_id) WHERE source_match_id IS NOT NULL
- idx_user_consents_user_id ON User_Consents(user_id)
- idx_user_consents_consent_type ON User_Consents(consent_type)
- idx_user_consents_agreed_at ON User_Consents(agreed_at)
- idx_contact_requests_user_id ON Contact_Requests(user_id) WHERE user_id IS NOT NULL
- idx_contact_requests_status ON Contact_Requests(status)

### 3.3 RLS（Row Level Security）ポリシー

#### Users
- 自分の情報のみ参照・更新可能

#### UserRoles
- 自分のロール情報を参照可能
- 大会管理者のみ権限付与可能（自分の大会のみ）

#### Tournaments
- 公開大会（is_public=true）は全ユーザーが参照可能
- 作成者（created_by_user_id）は自分の大会を管理可能
- 大会管理者（UserRoles.role='tournament_admin'）は自分の大会を管理可能

#### Teams
- チーム管理者（team_manager_user_id）は自分のチームを管理可能
- 公開大会のチームは参照可能

#### Tournament_Teams
- 公開大会の関連は参照可能
- 大会管理者は管理可能

#### Tournament_Players
- 公開大会の選手は参照可能
- 大会管理者は管理可能

#### Tournament_Pairs
- 公開大会のペアは参照可能
- 大会管理者は管理可能
- チーム管理者は自分のチームのペアを管理可能

#### Matches
- 審判（umpire_id）は担当試合を参照・更新可能
- 公開大会の試合は参照可能
- 大会管理者は管理可能

#### Match_Pairs
- 審判は担当試合のペアを参照可能
- チーム管理者は自分のチームのペアを管理可能
- 公開大会のペアは参照可能

#### Points
- 全ユーザーが参照可能
- 審判は担当試合のポイント入力のみ可能

#### Match_Scores
- 全ユーザーが参照可能
- 審判は担当試合のスコアを更新可能

#### Tournament_Phases
- 公開大会のフェーズは全ユーザーが参照可能
- 大会作成者は自分の大会のフェーズを管理可能
- 大会管理者は自分の大会のフェーズを管理可能
- マスタ権限ユーザーは全フェーズを管理可能

#### Tournament_Groups
- 公開大会のグループは参照可能
- 大会管理者は管理可能

#### Tournament_Entries
- 公開大会のエントリーは参照可能
- 大会管理者は管理可能

#### Match_Slots
- 公開大会のスロットは参照可能
- 大会管理者は管理可能

#### User_Consents
- 自分の同意ログのみ参照可能
- システム管理者（master_flag=true）は全ログ参照可能

#### Contact_Requests
- 自分の問い合わせのみ参照可能
- システム管理者（master_flag=true）は全問い合わせ参照可能

#### Audit_Logs
- システム管理者（master_flag=true）のみ参照可能

### 3.4 監査ログトリガー

- Points, Matches, Match_Scores, Tournaments, Teams, Users, UserRoles の変更を自動記録
- 5年間保持（cleanup_old_audit_logs関数）

## 4. APIエンドポイント

### 4.0 API共通仕様

#### ページネーション
- パラメータ: `limit`（取得件数）、`offset`（開始位置）
- デフォルト: limit=10（指定がない場合）
- 対応エンドポイント:
  - GET /tournaments（TournamentQueryDto）
  - GET /matches（MatchQueryDto）
  - GET /scoring/live（ScoreQueryDto）
  - GET /teams（TeamQueryDto）

#### ソート
- デフォルトソート: created_at DESC（作成日時の降順）
- カスタムソート: 各エンドポイントでorderパラメータ対応

#### レスポンス形式
- 成功時: HTTP 200 OK、JSON形式
- エラー時: HTTPステータスコード + エラーコード（E-CONFL-001等）
- 配列レスポンス: 常に配列形式（空の場合は空配列[]）

#### 認証
- 必須ヘッダー: `Authorization: Bearer {JWT_TOKEN}`
- トークン取得: POST /auth/login
- トークン保存: localStorage（access_token）

### 4.1 認証（/auth）

- POST /auth/login - ログイン
- POST /auth/signup - サインアップ
- POST /auth/forgot-password - パスワードリセットメール送信（実装済み）
- POST /auth/reset-password - パスワードリセット（トークン検証後、実装済み）
- DELETE /auth/account - アカウント削除（退会、実装済み）
- GET /auth/umpires - 審判一覧取得
- GET /auth/users - ユーザー一覧取得
- GET /auth/consent/check - 規約同意状況チェック（実装済み）
- POST /auth/consent/agree - 規約同意（実装済み）
- PUT /auth/profile - プロフィール更新（実装済み）
- PUT /auth/password - パスワード変更（実装済み）

### 4.2 大会管理（/tournaments）

- POST /tournaments - 大会作成
- GET /tournaments - 大会一覧取得
- GET /tournaments/:id - 大会詳細取得
- PUT /tournaments/:id - 大会更新
- DELETE /tournaments/:id - 大会削除
- GET /tournaments/:id/matches - 大会の試合一覧取得
- GET /tournaments/:id/teams - 大会のチーム一覧取得
- POST /tournaments/:id/teams - チーム追加
- DELETE /tournaments/:id/teams/:teamId - チーム削除
- GET /tournaments/:id/players - 選手一覧取得
- POST /tournaments/:id/players - 選手追加
- GET /tournaments/:id/pairs - ペア一覧取得
- POST /tournaments/:id/pairs - ペア追加
- PUT /tournaments/:id/pairs/:pairId - ペア更新
- DELETE /tournaments/:id/pairs/:pairId - ペア削除
- GET /tournaments/:id/entries - エントリー一覧取得
- POST /tournaments/:id/entries/import - CSVインポート
- GET /tournaments/:id/entries/export - CSVエクスポート
- POST /tournaments/:id/entries/:entryId/checkin - 当日受付（チェックイン）
  - 認証キー（4桁）を自動発行
  - is_checked_in=true, day_token設定, last_checked_in_at更新
- GET /tournaments/:id/entries/:entryId/token - 認証キー取得
- POST /scoring/matches/:matchId/verify-token - 認証キー検証（スコア入力開始前）
- GET /tournaments/:id/draw - ドロー取得
- PUT /tournaments/:id/draw - ドロー更新
- POST /tournaments/:id/draw/generate - ドロー生成
- POST /tournaments/:id/publish - 大会公開
- POST /tournaments/:id/finish - 大会終了

### 4.3 試合管理（/matches）

- POST /matches - 試合作成
- GET /matches - 試合一覧取得
- GET /matches/:id - 試合詳細取得
- PUT /matches/:id - 試合更新
- DELETE /matches/:id - 試合削除
- PUT /matches/:id/assign - 試合割当
- PUT /matches/:id/status - 試合ステータス更新
- GET /matches/:id/score - 試合スコア取得
- GET /matches/umpire/:umpireId - 審判の担当試合一覧取得
- POST /matches/:id/pairs - ペア提出
- GET /matches/:id/pairs - ペア取得
- PUT /matches/:id/pairs/:pairId - ペア更新
- DELETE /matches/:id/pairs/:pairId - ペア削除
- DELETE /matches/:id/umpire - 審判権限の強制解除（大会運営者のみ）
- PUT /matches/:id/umpire - 審判の強制変更（大会運営者のみ）
- POST /matches/:id/revert - 試合を差し戻す（finished → inprogress、大会運営者のみ）

### 4.4 スコアリング（/scoring）

- POST /scoring/points - ポイント入力
- POST /scoring/undo - Undo操作
- GET /scoring/matches/:matchId/score - 試合スコア取得
- GET /scoring/matches/:matchId/points - ポイント履歴取得
- PUT /scoring/matches/:matchId/score - スコア更新
- POST /scoring/matches/:matchId/start - 試合開始
- POST /scoring/matches/:matchId/pause - 試合中断
- POST /scoring/matches/:matchId/resume - 試合再開
- POST /scoring/matches/:matchId/finish - 試合終了
- PUT /scoring/matches/:matchId/score - スコアの直接修正（大会運営者のみ）
- GET /scoring/live - ライブ試合一覧取得

### 4.5 チーム管理（/teams）

- POST /teams - チーム作成
- GET /teams - チーム一覧取得
- GET /teams/:id - チーム詳細取得
- PUT /teams/:id - チーム更新
- DELETE /teams/:id - チーム削除
- GET /teams/:id/players - チームの選手一覧取得
- POST /teams/:id/players - 選手追加
- PUT /teams/players/:playerId - 選手更新
- DELETE /teams/players/:playerId - 選手削除
- GET /teams/:id/tournaments - チームの参加大会一覧取得

### 4.6 権限管理（/roles）

- POST /roles/assign - 権限付与
- DELETE /roles/remove - 権限削除
- GET /roles/users/:userId - ユーザーのロール一覧取得
- GET /roles/tournaments/:tournamentId - 大会のロール一覧取得
- GET /roles/permissions - 権限一覧取得
- POST /roles/check - 権限チェック

### 4.7 サポート・問い合わせ（/support）

- POST /support/contact - 問い合わせ送信（実装済み）
- GET /support/help - ヘルプセンター（FAQ一覧、実装済み）
- GET /terms - 利用規約表示（実装済み）
- GET /privacy - プライバシーポリシー表示（実装済み）
- GET /terms/[version] - 特定バージョンの利用規約取得（実装済み）
- GET /privacy/[version] - 特定バージョンのプライバシーポリシー取得（実装済み）

### 4.9 ヘルスチェック

- GET / - ヘルスチェック
- GET /health - アプリケーション状態確認

## 5. フロントエンド機能

### 5.1 認証・認可

#### ログイン画面（LoginForm）
- パス: `/`（未認証時、`*`でリダイレクト）
- 機能:
  - メールアドレス・パスワード入力
  - ログインボタン
  - サインアップ画面へのリンク
  - **「パスワードを忘れた場合」リンク**（`/support/forgot-password`へ遷移、実装済み）
  - エラーメッセージ表示
  - ログイン成功時: JWTとユーザー情報をlocalStorageに保存、規約同意状況をチェック
  - 規約同意が必要な場合: `/consent`へ遷移
  - 規約同意済みの場合: ダッシュボードへ遷移

#### パスワードリセット機能
- **実装状況**: 実装済み
- **パス**: `/support/forgot-password`（メール送信）、`/support/reset-password`（パスワード設定）
- **機能**:
  - ログイン画面から「パスワードを忘れた場合」リンクで遷移
  - メールアドレス入力画面（`/support/forgot-password`）
  - リセットメール送信（Supabase Auth経由）
  - リセットトークン検証
  - 新パスワード設定画面（`/support/reset-password`）
  - APIエンドポイント: POST /auth/forgot-password, POST /auth/reset-password

#### サインアップ画面（SignUpForm）
- パス: `/signup`
- 機能:
  - 表示名入力
  - メールアドレス入力
  - パスワード入力・確認
  - JSTA登録番号入力（オプション）
  - **利用規約・プライバシーポリシーへの同意**（実装済み）:
    - チェックボックス（必須）
    - 利用規約へのリンク（`/terms`）
    - プライバシーポリシーへのリンク（`/privacy`）
    - 同意なしでは送信不可（Zodバリデーション）
    - 同意時: 同意ログを記録（user_consentsテーブル）
  - サインアップボタン
  - ログイン画面へのリンク
  - バリデーションエラー表示
  - サインアップ成功時: ログイン画面へ遷移（`/login?registered=true`）

#### 規約同意画面（ConsentPage）
- パス: `/consent`
- 実装状況: 実装済み
- 機能:
  - **規約同意状況チェック**:
    - ログイン時に自動的に同意状況をチェック
    - 最新バージョンの規約・プライバシーポリシーに同意しているか確認
    - APIエンドポイント: GET /auth/consent/check
  - **再同意フロー**:
    - 規約・プライバシーポリシーが更新されている場合、再同意が必要
    - 利用規約への同意チェックボックス
    - プライバシーポリシーへの同意チェックボックス
    - 両方に同意しないと送信不可
  - **同意処理**:
    - 同意時: 同意ログを記録（user_consentsテーブル）
    - APIエンドポイント: POST /auth/consent/reagree
    - 同意成功後: ダッシュボードへ遷移
  - **無限リダイレクト防止**:
    - 再同意が不要な場合は自動的にダッシュボードへリダイレクト
  - **規約・ポリシーへのリンク**:
    - 利用規約（`/terms`）へのリンク
    - プライバシーポリシー（`/privacy`）へのリンク

#### ホームページ（HomePage）
- パス: `/`
- 実装状況: 実装済み
- 機能:
  - **ランディングページ**:
    - 未認証時のトップページ
    - アプリ名（Sport Link）と説明文を表示
    - 「ソフトテニス大会運営支援システム」の説明
    - 「リアルタイムスコアリング・ドロー自動生成・オフライン対応」の特徴表示
  - **アクションボタン**:
    - ログインボタン（`/login`へ遷移）
    - 新規登録ボタン（`/signup`へ遷移）
  - **スタイル**: グラデーション背景、中央配置のデザイン

### 5.11 ルーティング・画面遷移

**技術**: Next.js 14 App Routerを使用

#### 未認証時のルート
- `/`: ホームページ（ランディングページ、実装済み）
- `/signup`: サインアップ画面
- `/terms`: 利用規約ページ（常設、認証不要）
- `/privacy`: プライバシーポリシーページ（常設、認証不要）
- `/support/contact`: 問い合わせフォーム（認証不要）
- `/support/forgot-password`: パスワードリセットメール送信画面（認証不要）
- `/support/reset-password`: パスワードリセット画面（認証不要、トークン必須）
- `/support/help`: ヘルプセンター（認証不要）
- `/consent`: 規約同意画面（認証必須、実装済み）
- `*`: ログイン画面（リダイレクト）

#### 認証後のルート
- `/`, `/dashboard`: ダッシュボード
- `/tournaments`: 大会一覧
- `/tournaments/new`: 新規大会作成
- `/tournaments/:id`: 大会詳細
- `/tournaments/:id/edit`: 大会編集
- `/tournaments/:tournamentId/assignments`: 試合割当
- `/tournaments/:tournamentId/roles`: 権限管理
- `/tournaments/:tournamentId/draw`: ドロー管理
- `/tournaments/:tournamentId/entries`: エントリー管理
- `/tournaments/:tournamentId/results`: 試合結果
- `/tournaments/:tournamentId/live`: リアルタイム観戦
- `/scoring`: スコア入力一覧（実装済み、審判の担当試合一覧）
- `/scoring/:matchId`: 特定試合のスコア入力
- `/assigned-matches`: 担当試合一覧
- `/matches/:matchId`: 試合詳細
- `/teams`: チーム一覧
- `/teams/:teamId/players`: 選手一覧（実装済み）
- `/teams/:teamId/players/new`: 選手登録
- `/public-tournaments`: 公開大会一覧
- `/settings`: 設定
- `/notifications`: 通知一覧（実装済み）
- `*`: ダッシュボードにリダイレクト

#### 画面遷移フロー

##### 大会管理フロー
1. ダッシュボード → 大会一覧（`/tournaments`）
2. 大会一覧 → 大会詳細（`/tournaments/:id`）
3. 大会詳細 → 各管理画面:
   - 大会設定編集（`/tournaments/:id/edit`）
   - エントリー管理（`/tournaments/:id/entries`）
   - ドロー管理（`/tournaments/:id/draw`）
   - 試合割当（`/tournaments/:id/assignments`）
   - 権限管理（`/tournaments/:id/roles`）
   - 試合結果（`/tournaments/:id/results`）
4. 各管理画面 → 大会詳細（戻るボタン）

##### スコア入力フロー
1. ダッシュボード → 担当試合一覧（`/assigned-matches`）
2. 担当試合一覧 → スコア入力（`/scoring/:matchId`）
3. スコア入力 → 担当試合一覧（戻るボタン）

##### 試合管理フロー
1. 担当試合一覧 → 試合詳細（`/matches/:matchId`）
2. 試合詳細 → スコア入力（`/scoring/:matchId`）
3. 試合詳細 → 担当試合一覧（戻るボタン）

##### チーム管理フロー
1. ダッシュボード → チーム一覧（`/teams`）
2. チーム一覧 → 選手登録（`/teams/:teamId/players/new`）
3. 選手登録 → チーム一覧（保存/キャンセル）

##### ナビゲーション

#### 共通ヘッダー（AppHeader）
- **コンポーネント**: AppHeader
- **実装状況**: 実装済み
- **表示内容**:
  - 左側: ハンバーガーメニューボタン（NavigationMenu）、アプリ名（Sport Link）
  - 右側: 通知センター（NotificationCenter、ベルアイコン）、ユーザー名（display_name）、ログアウトボタン
- **スタイル**: スレート系のダークテーマ、グラデーションタイトル（from-blue-400 to-cyan-400）
- **レスポンシブ**: モバイル・デスクトップ対応

#### サイドバーナビゲーション（NavigationMenu）
- **コンポーネント**: NavigationMenu
- **実装状況**: 実装済み
- **表示形式**: ハンバーガーメニュー（左からスライドインするサイドバー）
- **メニュー項目**:
  - ダッシュボード（/dashboard、Homeアイコン）
  - 大会一覧（/tournaments、Trophyアイコン）
  - チーム一覧（/teams、Usersアイコン）
  - 設定（/settings、Settingsアイコン）
- **機能**:
  - アクティブなページのハイライト表示（bg-blue-500/20、text-blue-400）
  - メニュー開閉時のオーバーレイ表示（bg-black/50）
  - メニュー開閉時のbodyスクロール無効化
  - メニュー項目クリック時に自動でメニューを閉じる
  - 現在のパスに基づくアクティブ状態の判定
- **アクセシビリティ**: aria-label属性、キーボード操作対応

#### 通知センター（NotificationCenter）
- **実装状況**: 実装済み
- **表示場所**: ヘッダー右側のベルアイコン
- **機能**: 詳細は5.10 NotificationCenterを参照
- **通知の種類**: 認証キー表示、審判担当通知、試合待機通知

#### パンくずリスト（Breadcrumbs）
- **コンポーネント**: Breadcrumbs
- **実装状況**: 実装済み
- **機能**:
  - 現在のページ階層を表示
  - 各階層へのリンク（クリック可能）
  - 例: ダッシュボード > 大会一覧 > 大会詳細 > エントリー管理
  - ホームアイコンでダッシュボードへ遷移
- **表示場所**: 各画面のコンテンツ上部

#### 戻るボタン
- **表示場所**: 詳細画面・管理画面
- **機能**: 適切な戻り先へ遷移（navigate(-1)または明示的なパス指定）

#### ユーザーメニュー
- **表示内容**: 
  - ユーザー名（display_nameまたはemail）
  - ログアウトボタン
- **表示場所**: ヘッダー右側
- **機能**: ログアウト時にlocalStorageをクリアし、ログイン画面へ遷移

### 5.2 ダッシュボード

#### ダッシュボード（Dashboard）
- パス: `/`, `/dashboard`
- 概要: ユーザーが持つ「選手」「チーム管理者」「大会運営者」の3つの権限に応じた情報を集約して表示する、動的なダッシュボード
- **権限の定義**:
  - **選手**: `Tournament_Players`テーブルに登録されている、または`Tournament_Entries`にエントリーしているユーザー
  - **チーム管理者**: `team_manager_flag=true`または`user_permissions.role_type='team_admin'`のユーザー
  - **大会運営者**: `user_permissions.role_type='tournament_admin'`のユーザー

#### レイアウト構造
画面は大きく以下の2つのセクションで構成する。またタスクがある場合は通知としてnotificationsに表示する。

##### A. 権限別サマリセクション（中段）
- **構成**: 最大3行の水平ライン（行）
- **行の種類**:
  - **選手行**: [次の大会] [スタッツ] [公開大会数] [エントリー大会数]
  - **チーム管理者行**: [次の大会] [スタッツ] [公開大会数] [エントリー大会数]
  - **大会運営者行**: [管理大会数] [公開大会数] [エントリー状況]
- **UI/UXルール**:
  - **動的非表示**: カードの数値が0、またはその権限を保持していない場合は、カード単位・行単位で完全に非表示（DOMから削除または隠す）とする
  - **カードUI**: 横スクロール可能なカード形式。スマホ表示では40〜45%の幅で次のカードが少し見えるようにする
  - **選択状態**: カードタップ時、選択されたカードをハイライト（ボーダー強調やアクセントカラー付与）し、下部の「詳細エリア」を更新する

##### B. 詳細エリア（下段）
- **挙動**: サマリカードをタップした際、その内容に基づいたリストを表示する
- **表示内容**:
  - 関連する大会やデータのリスト（最大5件程度）
  - 各リストアイテムには「詳細を見る」ボタン（またはリンク）を配置
  - タップ時は、各大会の個別詳細ページ（`/tournaments/[id]` 等）へ遷移させる
- **初期状態**: 画面表示時に存在するカードのうち、最も左上にあるカードを自動選択して詳細を表示しておく

#### 各カードのデータ定義と遷移先

| 権限 | カード名 | 詳細エリアのリスト内容 | 遷移先 |
|------|---------|---------------------|--------|
| 選手 / チーム | 次の大会 | 直近の試合日程、会場 | 大会詳細ページ（`/tournaments/[id]`） |
| 選手 / チーム | スタッツ | 直近の試合結果（スコア） | 試合結果詳細（`/tournaments/[id]/results`） |
| 共通 | 公開中の大会 | 募集中の大会リスト | 大会エントリーページ（`/public-tournaments`） |
| 共通 | エントリー中 | 進行中・申込済の大会リスト | 大会詳細ページ（`/tournaments/[id]`） |
| 大会運営者 | エントリー状況 | 未処理のエントリー申請 | エントリー管理ページ（`/tournaments/[id]/entries`） |

#### 技術的要件・制約
- **レスポンシブ**: モバイルファーストで設計し、縦スクロールを最小限に抑える
- **ステート管理**: どのカードが「アクティブ」であるかを管理し、詳細エリアをリアクティブに更新する
- **拡張性**: 権限が増えた場合でも、行を追加しやすいコンポーネント設計にする
- **Empty State**: すべての権限で表示データが0の場合のみ、「現在表示できるデータがありません」というプレースホルダーを表示する

#### 実装済み機能（互換性維持）
- **審判割り当てセクション**（既存実装）:
  - リアルタイム試合一覧表示（進行中・待機中）
  - 試合ステータス表示（進行中、待機中、終了）
  - **チーム名表示**（実装済み）:
    - `match.match_pairs`から`teams.name`を取得して表示
    - 取得できない場合のみ「チームA」「チームB」をフォールバック表示
  - 試合詳細へのリンク
- **接続エラー表示**: バックエンドサーバー接続エラー時の表示と再試行ボタン

### 5.3 大会管理

#### 大会一覧（TournamentManagement）
- パス: `/tournaments`
- 機能:
  - 大会一覧表示
  - **フィルター機能**:
    - 大会名検索（テキスト入力、リアルタイム検索）
    - ステータスフィルター（すべて、下書き、公開中、終了）
    - **日付範囲フィルター**（実装済み）:
      - 開始日フィルター（startDate）
      - 終了日フィルター（endDate）
      - フィルターリセットボタン
  - 新規大会作成ボタン
  - 大会カードクリックで詳細画面へ遷移
  - 権限に応じた表示（管理権限がある場合は「管理」ボタン表示）
  - 権限チェック（各大会のtournament_admin権限を確認）

#### 大会詳細（TournamentDetail）
- パス: `/tournaments/:id`
- 機能: 大会管理機能へのナビゲーションハブ
- **大会情報表示**:
  - 大会名、説明
  - ステータス表示（下書き、公開中、終了）
- **直接アクションボタン**（実装済み）:
  - **大会公開ボタン**（下書き時のみ表示）:
    - ワンクリックで大会を公開（status='published'に変更）
    - 確認ダイアログ表示（「大会を公開しますか？」）
    - APIエンドポイント: POST /tournaments/:id/publish
  - **大会終了ボタン**（公開中時のみ表示）:
    - ワンクリックで大会を終了（status='finished'に変更）
    - 確認ダイアログ表示（「大会を終了しますか？終了後は変更できません」）
    - APIエンドポイント: POST /tournaments/:id/finish
- **管理機能メニュー**:
  - 大会設定編集（`/tournaments/:id/edit`へ遷移）
  - エントリー管理（`/tournaments/:id/entries`へ遷移）
  - ドロー管理（`/tournaments/:id/draw`へ遷移）
  - 試合管理（`/tournaments/:id/assignments`へ遷移）
  - 権限管理（`/tournaments/:id/roles`へ遷移）
  - 試合結果（`/tournaments/:id/results`へ遷移）

#### 大会作成・編集（TournamentEdit）
- パス: `/tournaments/new`（新規作成）、`/tournaments/:id/edit`（編集）
- 機能:
  - **フォーム項目**:
    - 大会名（必須）
    - 説明（オプション）
    - ステータス（下書き、公開中、終了）
    - 公開設定（チェックボックス）
    - 試合形式（5G/7G/9G、オプション）
    - 対戦方式（team_doubles_3, team_doubles_4_singles_1, individual_doubles, individual_singles）
    - **審判モード**（必須、デフォルト: LOSER）:
      - 敗者審判モード（LOSER）: 前試合の敗者が審判を担当（標準）
      - 運営割当モード（ASSIGNED）: 運営が指名した審判のみ入力可能
      - フリーモード（FREE）: 誰でも入力可能（練習試合等）
    - 開始日（オプション）
    - 終了日（オプション）
  - **編集モード**: 既存データの読み込み
  - **保存**: 作成/更新API呼び出し、成功時は大会詳細画面へ遷移
  - **キャンセル**: 大会一覧へ戻る

#### エントリー管理（EntryManagement）
- パス: `/tournaments/:tournamentId/entries`
- 機能:
  - **チーム管理**:
    - チーム一覧表示
    - チーム追加（モーダル）
    - チーム編集・削除
  - **選手管理**:
    - チームごとの選手一覧表示
    - 選手追加（モーダル）
    - 選手編集・削除
    - 選手タイプ（前衛/後衛）設定
  - **ペア管理**:
    - ペア一覧表示（対戦方式に応じて表示）
    - ペア追加（モーダル）
    - ペア編集・削除
    - ダブルス/シングルス対応
  - **当日受付（チェックイン）**:
    - エントリー一覧表示（チェックイン状態表示）
    - チェックイン機能:
      - 選手名選択（ドロップダウン）
      - チェックインボタン
      - 認証キー（4桁）自動発行・表示
      - 認証キーは通知センターに保存・表示
    - チェックイン状態の確認（is_checked_in, last_checked_in_at）
  - **CSVインポート/エクスポート**:
    - CSVファイルアップロード
    - CSVエクスポートボタン
    - エラーハンドリング
  - **対戦方式別の表示制御**:
    - 団体戦: チーム+選手管理
    - 個人戦: チーム+ペア+選手管理

#### ドロー管理（DrawManagement）
- パス: `/tournaments/:tournamentId/draw`
- 機能:
  - **ドロー自動生成**:
    - ドロー自動生成ボタン
    - 生成確認ダイアログ（「既存のドローは上書きされます」）
    - 生成成功時: ドローを再読み込み
  - **ドロー表示**:
    - ブラケット表示（bracket）: トーナメント表形式（TournamentBracketコンポーネント）
    - リスト表示（list）: 試合一覧形式
    - 表示モード切り替えボタン（bracket/list）
  - **フェーズ管理**:
    - フェーズ選択（複数フェーズがある場合）
    - フェーズ切り替えボタン
  - **試合情報表示**:
    - ラウンド名、試合番号
    - エントリー情報（エントリー名、シード番号）
    - **チーム名表示**（実装済み）:
      - `pair.teams?.name`からチーム名を取得して表示
      - 取得できない場合のみ`チーム${idx + 1}`をフォールバック表示
    - スロット情報（エントリー、勝者枠、敗者枠、不戦勝）
    - 試合ステータス
  - **注意**: 手動編集機能は未実装（自動生成のみ）

#### 試合割当（MatchAssignment）
- パス: `/tournaments/:tournamentId/assignments`
- 機能:
  - **試合一覧表示**:
    - ラウンド名、ステータス表示
    - **チーム名表示**（実装済み）:
      - `match.match_pairs`から`teams.name`を取得して表示
      - APIエンドポイントで`match_pairs`と`teams`をJOINして取得
    - 現在の審判・コート番号表示
  - **審判割り当て**:
    - 審判一覧取得（umpire_flag=trueのユーザー）
    - ドロップダウンで審判選択
    - 一括割り当て機能
  - **コート番号設定**:
    - コート番号入力
    - 一括設定機能
  - **保存機能**:
    - 変更内容を一括保存
    - 保存成功時: 大会詳細画面へ遷移
  - **審判権限の強制上書き**（大会運営者のみ）:
    - 「審判を変更」ボタンで別の審判に再割当
    - 変更確認ダイアログ表示
    - APIエンドポイント: DELETE /matches/:matchId/umpire, PUT /matches/:matchId/umpire
    - 試合進行中（inprogress）でも強制解除・変更可能
  - **フィルター機能**:
    - ステータスでフィルタリング
    - ラウンドでフィルタリング

#### 権限管理（RoleManagement）
- パス: `/tournaments/:tournamentId/roles`
- 機能:
  - **ユーザー一覧表示**:
    - 全ユーザー一覧
    - 現在の権限状態表示
  - **権限割り当て**:
    - tournament_admin（大会運営者）: チェックボックス
    - scorer（審判）: チェックボックス
    - ユーザーごとに権限を個別設定
  - **保存機能**:
    - 変更内容を一括保存
    - 権限付与・削除API呼び出し
    - 保存成功時: 大会詳細画面へ遷移
  - **権限確認**: 各ユーザーの現在の権限を取得・表示

#### 試合結果（MatchResults）
- パス: `/tournaments/:tournamentId/results`
- 機能:
  - 試合結果一覧表示（status='finished'の試合のみ）
  - **フィルター機能**:
    - **検索機能**（実装済み）:
    - ラウンド名検索（テキスト入力、リアルタイム検索）
      - **チーム名での検索**（実装済み）: チームA名、チームB名を検索対象に含む
    - ステータスフィルター（すべて、終了、進行中、待機中）
    - ラウンドフィルター（ドロップダウン、一意のラウンド名一覧）
  - **試合結果表示**:
    - ラウンド名、スコア表示
    - **チーム名表示**（実装済み）:
      - `match.match_pairs[0]?.teams?.name`と`match.match_pairs[1]?.teams?.name`からチーム名を取得
      - 取得できない場合のみ「チームA」「チームB」をフォールバック表示
    - 試合ステータス表示
    - 試合詳細へのリンク
  - **試合確定機能**（大会運営者のみ）:
    - 試合確定ボタン（finished試合のみ）
    - 確定確認ダイアログ（「確定後はスコアの変更ができなくなります」）
    - 確定後はスコア変更不可
  - **試合差し戻し機能**（大会運営者のみ）:
    - 「試合を差し戻す」ボタン（finished試合のみ表示）
    - 差し戻し確認ダイアログ（「この操作により、スコアの修正が可能になります。確定済みの試合も差し戻せます」）
    - 差し戻し後、試合ステータスを`finished`から`inprogress`に変更
    - スコア入力画面から再度スコア修正が可能
    - APIエンドポイント: POST /matches/:matchId/revert
    - 次試合が既に開始されている場合、警告メッセージを表示
  - **スコア直接修正機能**（大会運営者のみ）:
    - 「スコアを直接修正」ボタン（finished試合のみ表示）
    - ゲームカウント、現在のスコアを直接入力
    - 確認ダイアログ表示後、スコアを更新
    - APIエンドポイント: PUT /scoring/matches/:matchId/score
  - **エクスポート機能**:
    - CSV形式: 試合結果のCSVエクスポート
    - PDF形式: 試合結果のPDFエクスポート（実装予定）

### 5.4 スコア入力

#### スコア入力一覧（ScoringListPage）
- パス: `/scoring`
- 実装状況: 実装済み
- 機能:
  - **審判の担当試合一覧表示**:
    - ログインユーザー（審判）に割り当てられた試合一覧を表示
    - APIエンドポイント: GET /matches/umpire/:umpireId
  - **フィルター機能**:
    - 検索クエリ（大会名、ラウンド名で検索）
    - ステータスフィルター（すべて、待機中、進行中、終了）
    - 大会フィルター（ドロップダウン、一意の大会名一覧）
  - **試合情報表示**:
    - 大会名、ラウンド名
    - 試合ステータス（待機中、進行中、終了）
    - **チーム名表示**（実装済み）:
      - `getTeamNames`関数で`match.match_pairs`から`teams.name`を取得
      - `pair_number`でペアを特定し、チームA/Bを判定
      - 取得できない場合のみ「チームA」「チームB」をフォールバック表示
    - スコア表示（ゲームカウント）
    - コート番号
  - **アクション**:
    - 各試合をクリックでスコア入力画面（`/scoring/:matchId`）へ遷移
    - 試合詳細画面（`/matches/:matchId`）へのリンク

#### 審判スコアボード（UmpireScoreboard）
- パス: `/scoring/:matchId`（特定試合）
- 機能:
  - **認証キー入力**（敗者審判モード時）:
    - スコア入力開始前に認証キー（4桁）の入力が必要
    - 認証キーは通知センターから確認可能
    - 認証キー検証成功後、スコア入力開始
    - 認証キー不一致時はエラーメッセージ表示
  - **試合情報表示**:
    - 大会名、ラウンド名
    - **チーム名表示**（実装済み）:
      - `match.match_pairs[0]?.teams?.name`と`match.match_pairs[1]?.teams?.name`からチーム名を取得
      - APIエンドポイント（GET /api/matches/:id）で`match_pairs`と`teams`をJOINして取得
      - 取得できない場合のみ「チームA」「チームB」をフォールバック表示
    - ペア情報（選手名）
    - コート番号
  - **スコア表示**:
    - ゲームカウント（A/B）
    - 現在のゲームスコア（A/B）
    - リアルタイム更新（アニメーション）
  - **試合制御**:
    - 試合開始ボタン（pending時）
    - 試合中断ボタン（進行中時、pauseMatch API）
    - 試合再開ボタン（paused時、resumeMatch API）
    - 試合終了ボタン（進行中時）
    - 試合終了確認ダイアログ
    - 試合ステータス: pending, inprogress, paused, finished
  - **ポイント入力**:
    - チームAポイント追加ボタン（大ボタン、キーボードショートカット: A）
    - チームBポイント追加ボタン（大ボタン、キーボードショートカット: B）
    - Undoボタン（キーボードショートカット: U）
  - **接続状態表示**:
    - ConnectionStatusコンポーネント
    - 接続中/切断/再接続中の表示
  - **オフライン対応**:
    - オフライン時のポイント入力（キューに保存）
    - オンライン復帰時の自動同期
    - 同期中の表示
  - **エラーハンドリング**:
    - 競合エラー（409 Conflict）時の再同期
    - エラーメッセージ表示
  - **審判権限の自動委譲**（敗者審判モード時）:
    - 試合終了時、敗者の認証キーに対して次試合の入力権限を自動有効化
    - 通知センターに審判担当通知を表示

### 5.5 チーム管理

#### チーム一覧（TeamManagement）
- パス: `/teams`
- 機能:
  - **チーム一覧表示**:
    - チーム名、学校名
    - 選手数、作成日
    - チーム管理者情報
  - **チーム管理**:
    - 新規チーム作成ボタン
    - チーム編集ボタン（チーム管理者のみ）
    - 選手管理ボタン（`/teams/:teamId/players`へ遷移）
    - 戦績確認ボタン
  - **検索機能**:
    - チーム名・学校名での検索
  - **戦績表示**:
    - 総試合数、勝利数、敗北数
    - 勝率、優勝回数

#### 選手一覧（PlayersPage）
- パス: `/teams/:teamId/players`
- 実装状況: 実装済み
- 機能:
  - **チーム情報表示**:
    - チーム名、学校名を表示
  - **選手一覧表示**:
    - チームに所属する選手一覧をグリッド形式で表示
    - 選手名、ポジション（前衛/後衛/両方）を表示
  - **選手管理**:
    - 選手追加ボタン（`/teams/:teamId/players/new`へ遷移）
    - 選手編集ボタン（各選手カードに表示、`/teams/:teamId/players/:playerId/edit`へ遷移）
    - 選手削除ボタン（確認ダイアログ表示後、削除実行）
    - APIエンドポイント: DELETE /teams/players/:playerId
  - **空状態表示**:
    - 選手が登録されていない場合、空状態メッセージと選手追加ボタンを表示
  - **パンくずリスト**: チーム一覧 > チーム名 > 選手一覧

#### 選手登録（PlayerRegistration）
- パス: `/teams/:teamId/players/new`
- 実装状況: 実装済み
- 機能:
  - **フォーム項目**:
    - 選手名（必須）
    - ポジション（前衛/後衛/両方、必須）
  - **保存**: 選手追加API呼び出し、成功時は`/teams/:teamId/players`へ遷移
  - **キャンセル**: 選手一覧へ戻る（`/teams/:teamId/players`）

### 5.6 試合管理

#### 担当試合一覧（AssignedMatches）
- パス: `/assigned-matches`
- 機能:
  - 審判に割り当てられた試合一覧表示
  - 試合ステータス表示（待機中、進行中、終了）
  - **チーム名表示**（実装済み）:
    - `match.match_pairs[0]?.teams?.name`と`match.match_pairs[1]?.teams?.name`からチーム名を取得
    - 取得できない場合のみ「チームA」「チームB」をフォールバック表示
  - スコア表示
  - 試合開始・スコア入力・結果確認への遷移

#### 試合詳細（MatchDetail）
- パス: `/matches/:matchId`
- 機能:
  - **試合情報表示**:
    - 大会名、ラウンド名
    - 試合ステータス（pending, inprogress, finished）
    - コート番号、審判名
    - 開始時刻、終了時刻
  - **ペア情報表示・編集**（団体戦の場合）:
    - **チーム名表示**（実装済み）:
      - `match.match_pairs`から`teams.name`を取得して表示
      - `pair.teams?.name || \`チーム${idx + 1}\``でフォールバック表示
    - 自分のチームのペア提出:
      - ペア追加（必要なペア数分）
      - ペア編集（pending時のみ）
      - ペア提出ボタン（必要なペア数が揃った時）
      - 提出済み/未提出の表示
    - 対戦相手チームのペア情報表示（参照のみ）
  - **ペア情報表示**（個人戦の場合）:
    - **チーム名表示**（実装済み）:
      - `match.match_pairs`から`teams.name`を取得して表示
    - 全ペア情報の表示（参照のみ）
  - **スコア表示**:
    - ゲームカウント
    - 現在のゲームスコア
  - **アクション**:
    - **スコア入力画面への遷移**（実装済み）:
      - pending時: 「試合開始・スコア入力」ボタン（`/scoring/:matchId`へ遷移）
      - inprogress時: 「スコア入力」ボタン（`/scoring/:matchId`へ遷移）
    - 試合結果確認への遷移
  - **権限チェック**:
    - チーム管理者のみペア提出可能
    - 試合開始後（inprogress/finished）はペア編集不可

### 5.7 公開機能

#### 公開大会一覧（PublicTournaments）
- パス: `/public-tournaments`
- 機能:
  - 公開大会一覧表示
  - **フィルター機能**:
    - 大会名検索（テキスト入力、リアルタイム検索）
    - タイプフィルター（全て表示、管理大会、エントリー済、公開大会）
    - ステータスフィルター（全て、進行中、受付中、終了、受付前）
  - フィルター条件の組み合わせ検索

#### リアルタイム観戦（LiveScoreView）
- パス: `/tournaments/:tournamentId/live`
- 機能:
  - **ライブ試合一覧表示**:
    - 進行中・終了した試合の一覧
    - **チーム名表示**（実装済み）:
      - `match.match_pairs[0]?.teams?.name`と`match.match_pairs[1]?.teams?.name`からチーム名を取得
      - APIエンドポイント（GET /api/scoring/live）で`match_pairs`と`teams`をJOINして取得
      - 取得できない場合のみ「チームA」「チームB」をフォールバック表示
    - スコア表示
    - 試合ステータス（進行中、終了）
    - コート番号表示
  - **リアルタイム更新**:
    - 5秒ごとの自動更新
    - スコアのリアルタイム反映
  - **試合詳細へのリンク**: 各試合をクリックで詳細表示

### 5.8 設定

#### 設定（Settings）
- パス: `/settings`
- 機能:
  - **タブ切り替え**:
    - プロフィール
    - 通知設定
    - アプリ設定
    - セキュリティ
  - **プロフィール設定**（実装済み）:
    - 表示名編集
    - メールアドレス表示（編集不可）
    - 保存ボタン
    - APIエンドポイント: PUT /auth/profile
  - **パスワード変更**（実装済み）:
    - 現在のパスワード入力
    - 新しいパスワード入力・確認
    - パスワード変更ボタン
    - APIエンドポイント: PUT /auth/password
  - **通知設定**:
    - メール通知（ON/OFF）
    - プッシュ通知（ON/OFF）
    - 試合更新通知（ON/OFF）
    - 大会更新通知（ON/OFF）
    - 注: 現在はUIのみ実装、設定の永続化は未実装
  - **アプリ設定**:
    - テーマ（ダーク/ライト）
    - 言語（日本語/英語）
    - 自動同期（ON/OFF）
    - オフラインモード（ON/OFF）
    - 注: 現在はUIのみ実装、設定の永続化は未実装
  - **セキュリティ**（実装済み）:
    - パスワード変更（実装済み）:
      - 現在のパスワード入力
      - 新しいパスワード入力・確認
      - APIエンドポイント: PUT /auth/password
    - **アカウント削除（退会）ボタン**（実装済み）:
      - 退会確認ダイアログ表示
      - パスワード再入力（セキュリティ確認）
      - 退会処理実行（Supabase Auth + usersテーブルから削除）
      - APIエンドポイント: DELETE /auth/account
    - ログアウトボタン（実装済み）

### 5.9 状態管理（Zustand）

#### 認証ストア（useAuthStore）
- 状態:
  - `user`: User | null（ユーザー情報）
  - `isAuthenticated`: boolean（認証状態）
  - `isLoading`: boolean（ローディング状態）
- アクション:
  - `login(email, password)`: ログイン処理、JWTとユーザー情報をlocalStorageに保存
  - `logout()`: ログアウト処理、localStorageをクリア
  - `setUser(user)`: ユーザー情報を設定

#### マッチストア（useMatchStore）
- 状態:
  - `matchState`: MatchState | null（試合状態）
  - `connectionState`: 'CONNECTED' | 'DISCONNECTED' | 'RECONNECTING'（接続状態）
- MatchState構造:
  - `matchId`: string
  - `umpireId`: string
  - `matchStatus`: 'pending' | 'inprogress' | 'finished'
  - `serverVersion`: number（楽観的ロック用）
  - `localQueue`: OfflinePoint[]（オフラインキュー）
  - `gameCountA/B`: number（ゲームカウント）
  - `currentScoreA/B`: string（現在のスコア表示）
  - `pointsHistory`: Point[]（ポイント履歴）
  - `isSyncing`: boolean（同期中フラグ）
  - `hasConflict`: boolean（競合フラグ）
- アクション:
  - `setMatchState(state)`: 試合状態を設定
  - `updateScore(...)`: スコアを更新
  - `addPointToQueue(point)`: オフラインキューにポイントを追加
  - `setConnectionState(state)`: 接続状態を設定
  - `setSyncing(syncing)`: 同期中フラグを設定
  - `setConflict(hasConflict)`: 競合フラグを設定

### 5.10 UIコンポーネント（共通コンポーネント）

#### Modal
- モーダルダイアログ表示
- サイズ: sm, md, lg, xl
- オーバーレイクリックで閉じる機能
- ESCキーで閉じる機能
- フォーカス管理（アクセシビリティ対応）
- ConfirmDialog: 確認ダイアログ（削除確認など）

#### Toast
- 通知メッセージ表示（成功、エラー、警告、情報）
- ToastProvider: コンテキストプロバイダー
- useToast: フック経由で使用
- 自動非表示機能

#### Loading
- ローディングスピナー表示
- サイズ: sm, md, lg
- LoadingOverlay: オーバーレイ付きローディング

#### Skeleton
- ローディング中のプレースホルダー表示
- カスタマイズ可能な幅・高さ
- SkeletonList: リスト用スケルトン
- SkeletonCard: カード用スケルトン

#### EmptyState
- 空状態表示（データがない場合）
- アイコン、タイトル、説明、アクションボタン対応

#### ConnectionStatus
- リアルタイム接続状態表示
- 状態: CONNECTED, DISCONNECTED, RECONNECTING
- アイコンとメッセージ表示

#### NotificationCenter（通知センター）
- **表示場所**: 共通ヘッダー上のベルアイコン
- **実装状況**: 実装済み
- **機能**:
  - **通知一覧表示**:
    - 認証キー表示（チェックイン時に発行された4桁の認証キー）
    - 試合待機通知（担当試合の前の試合開始通知）
    - 審判担当通知（敗者審判モード時、審判担当が回ってきた際の通知）
    - 認証キーのリマインド（審判担当時の認証キー表示）
  - **認証キーの保存**:
    - LocalStorageに保存（大会終了まで有効）
    - ブラウザを閉じても保持
    - 常時表示（いつでも確認可能）
  - **通知の種類**:
    - `auth_key`: 認証キー発行通知（チェックイン完了時）
    - `umpire_assignment`: 審判担当通知（試合終了時、次試合の審判権限が有効化された際）
    - `match_waiting`: 試合待機通知（担当試合の前の試合が開始）
  - **通知の管理**:
    - 未読/既読の管理
    - 通知の削除
    - 通知の一括削除
    - 通知一覧画面（/notifications、実装済み）
- **技術実装**:
  - useNotificationStore（Zustand）による状態管理
  - LocalStorageへの永続化（persist middleware）
  - 通知クリック時の画面遷移対応

## 6. 認証・認可

### 6.1 認証方式

- JWT（JSON Web Token）
- Supabase Auth（パスワードハッシュ: bcrypt）
- セッション管理: localStorage

### 6.2 ユーザーロール

- master（マスタ）: 全権限
- master_manager（マスタ管理者）: システム管理権限
- tournament_admin（大会運営者）: 大会作成・管理、ドロー生成
- scorer（審判）: リアルタイムスコア入力
- team_manager（チーム管理者）: チーム・選手管理
- player（選手）: 戦績閲覧
- guest（観戦者）: 公開大会・スコア閲覧

### 6.3 権限チェック

- JwtAuthGuard: JWT認証
- RLSInterceptor: Row Level Security適用
- フロントエンド: ロールベースUI制御

### 6.4 RLSセッション変数設定フロー

#### ユーザーID伝達シーケンス

1. **JWT認証**: クライアントがAuthorization: Bearer <JWT>ヘッダーを付けてAPIリクエストを送信
2. **トークン検証/デコード**: NestJS (Auth Guard)がJWTをデコードし、Payloadからsubフィールド（ユーザーID/UUID）を抽出
3. **セッションID抽出**: 抽出したユーザーIDをRequestオブジェクト（req.user.id）に格納
4. **DB接続/トランザクション開始**: DB接続プールからコネクションを取得
5. **RLSセッション変数の設定**: トランザクション開始直後、`SELECT set_config('app.current_user_id', :userId, FALSE)`を実行
6. **DB操作**: INSERTやUPDATEなどのCRUD操作を実行（全てRLSポリシーによってフィルタリング）
7. **トランザクション終了**: コミットまたはロールバック（セッション変数は接続がプールに戻される際にリセット）

#### TransactionManagerService

- `runInTransaction<T>(callback: (client: SupabaseClient) => Promise<T>, userId: string)`: 
  - DBクライアントを取得
  - `set_config('app.current_user_id', :userId, FALSE)`を実行
  - callback関数内でトランザクションを実行
  - セッション変数のライフサイクルを保証

#### RLSInterceptor

- リクエストがコントローラーに到達する前に、認証済みのuserIdを取得
- TransactionManagerServiceを使用してRLSセッション変数を設定
- DBから返されたRLS関連のPostgreSQLエラーを捕捉し、E-RLS-002 (403) に変換

## 7. リアルタイム機能

### 7.1 Supabase Realtime

- 試合スコアのリアルタイム購読（match_scores, points）
- ライブ試合一覧のリアルタイム更新
- 大会ステータスのリアルタイム更新
- 審判の担当試合一覧のリアルタイム更新

### 7.2 接続状態管理

- チャンネル状態監視（SUBSCRIBED, SUBSCRIBING, CHANNEL_ERROR, CLOSED, TIMED_OUT）
- 接続状態表示（ConnectionStatusコンポーネント）
- 自動再接続

## 8. オフライン対応

### 8.1 PWA機能

#### Service Worker（Workbox）
- 自動更新: registerType='autoUpdate'
- キャッシュ戦略:
  - 静的ファイル: プリキャッシュ（js, css, html, ico, png, svg）
  - API: NetworkFirst（タイムアウト3秒）
  - Supabase: NetworkFirst（タイムアウト3秒）
- キャッシュ名: api-cache, supabase-cache

#### PWA Manifest
- アプリ名: Sport Link
- 短縮名: SportLink
- 表示モード: standalone（スタンドアロン）
- 画面向き: portrait（縦向き固定）
- テーマカラー: #1f2937
- 背景色: #111827
- アイコン: 192x192, 512x512（maskable対応）

#### IndexedDB（Dexie）
- オフラインキューの管理
- ストレージ容量制限: 50MB以下（試合終了後48時間で自動削除）
- データ保持: 割り当てられた試合情報と大会概要のみ

### 8.2 オフライン保存データ

- Points（ポイント記録）
- Match Actions（試合アクション: start, finish, assign）
- Tournament Actions（大会アクション: create, update, delete, publish, finish）

### 8.3 同期機能

- オンライン復帰時の自動同期
- 指数バックオフ付きリトライ（最大3回）
- 競合解決（409 Conflict処理）

## 9. スコアリングロジック

### 9.1 スコア計算エンジン

- ScoreEngineProvider: ピュアな計算ロジック
- ポイント履歴からスコアを再計算
- ゲームカウント、現在のポイント、ファイナルゲーム判定

### 9.2 スコアリングルール

#### 通常ゲーム
- スコア進行: 0 → 1 → 2 → 3 → Game
- ゲーム終了条件: 4ポイント先取 & 2ポイント差
- デュース: 3-3になった場合、デュース状態
- アドバンテージ: デュース後、1ポイント差でアドバンテージ（例: AD-3）
- デュース復帰: アドバンテージ側がポイントを失うとデュースに戻る

#### ファイナルゲーム（タイブレーク）
- 開始条件: ゲームカウントがgamesToWin-1同点になった時点（例: 7ゲームマッチなら3-3）
- スコア進行: 0, 1, 2, 3, 4, 5, 6, 7...（通常のポイント数）
- 終了条件: 7ポイント先取 & 2ポイント差
- ファイナルゲーム終了時点で必ずgamesToWinに達する

#### gamesToWin設定
- トーナメント設定（Tournament_Phases.config.gamesToWin）から取得
- デフォルト: 4（7ゲームマッチ = 4ゲーム先取）
- ファイナルゲーム閾値: gamesToWin - 1（例: gamesToWin=4なら3-3でファイナルゲーム開始）

#### スコア表示
- 通常ゲーム: 0, 1, 2, 3, 4（または"Deuce", "AD"）
- ファイナルゲーム: 0, 1, 2, 3, 4, 5, 6, 7...
- ゲームカウント: 0, 1, 2, 3, 4...（試合全体のゲーム数）

### 9.3 楽観的ロック

- Matches.version を使用
- 競合時は409 Conflictエラー
- クライアント側で再同期

### 9.4 Undo機能

- 最新ポイントを論理削除（is_undone=TRUE）
- スコアを再計算
- バージョンを更新
- 権限制限: 試合終了後、結果確定前のUndo権限は大会運営者のみ
- オフライン制限: 未同期トランザクション（キュー）が存在する場合、E-SYNC-PENDINGエラーでブロック
- 監査ログ: Undo操作はAudit_Logsに詳細な変更履歴と共に記録

## 10. ドロー生成ロジック

### 10.1 ドローエンジン

- DrawEngineService: シングルエリミネーション生成
- エントリー数からラウンド数・ブラケットサイズを計算
- シード配置アルゴリズム
- 所属重複回避（balanceAffiliations）

### 10.2 ドロー生成手順

1. エントリー取得・前処理
2. シード配置（優先順位: 明示シード > 戦績スコア > 所属重複回避 > 番手分散）
3. ブラケット生成（2の累乗に拡張、BYE設定）
4. 試合作成（Matches, Match_Pairs）

### 10.3 ドロー構造

- Phases（フェーズ）: tournament, league
- Rounds（ラウンド）: 各フェーズ内のラウンド
- Matches（試合）: 各ラウンドの試合
- Slots（スロット）: 各試合の対戦者スロット

## 11. エントリー管理

### 11.1 エントリータイプ

- team: チームエントリー（Tournament_Entries.entry_type='team'）
- pair: ペアエントリー（Tournament_Entries.entry_type='pair'）

### 11.2 ペアエントリー管理

- Tournament_Pairsテーブルでペア単位のエントリーを管理
- 団体戦の場合: team_id必須、pair_numberでチーム内のペア番号を管理
- 個人戦の場合: team_id=NULL、pair_numberは使用しない
- ダブルス: player_1_idとplayer_2_id両方必須
- シングルス: player_1_idのみ、player_2_id=NULL

### 11.3 CSVインポート/エクスポート

#### CSVエクスポート形式
- ファイル名: `tournament-{tournamentId}-entries.csv`
- エンコーディング: UTF-8
- ヘッダー行: `チーム名,選手名,ポジション`
- データ行: チーム名、選手名、ポジション（前衛/後衛）をカンマ区切り
- 選手がいないチーム: チーム名のみ、選手名とポジションは空

#### CSVインポート形式
- 必須カラム:
  - チーム名（team/チームを含むカラム名）
  - 選手名（player/選手/name/名前を含むカラム名）
  - ポジション（type/ポジション/positionを含むカラム名、オプション）
- フォーマット: UTF-8、カンマ区切り
- ヘッダー行必須
- エラーハンドリング:
  - 必須カラムがない場合はエラー
  - データ行が1行未満の場合はエラー
  - 各行の処理結果を返却

## 12. 環境設定

### 12.1 バックエンド環境変数

- SUPABASE_URL
- SUPABASE_ANON_KEY
- SUPABASE_SERVICE_ROLE_KEY
- JWT_SECRET
- JWT_EXPIRES_IN
- DATABASE_URL
- PORT
- NODE_ENV
- SKIP_PASSWORD_VERIFICATION（開発環境のみ）
- CORS_ORIGIN

### 12.2 フロントエンド環境変数

- VITE_SUPABASE_URL
- VITE_SUPABASE_ANON_KEY
- VITE_API_URL
- VITE_APP_NAME
- VITE_APP_DESCRIPTION

### 12.3 Supabase設定

- API Port: 54321
- Database Port: 54322
- Studio Port: 54323
- Realtime: enabled
- Auth: enabled

## 13. デプロイメント

### 13.1 Docker構成

#### Backend Dockerfile
- ベースイメージ: node:18-alpine
- ビルドステップ: npm ci --only=production → npm run build
- ポート: 3000
- 起動コマンド: npm run start:prod

#### Frontend Dockerfile
- ビルドステージ: node:18-alpine（ビルド用）
- 本番ステージ: nginx:alpine（配信用）
- ビルドステップ: npm ci → npm run build
- 配信: Nginxで静的ファイル配信
- ポート: 80

#### Docker Composeサービス
- backend: NestJS API
- frontend: Nginx + React
- supabase-db: PostgreSQL 15.1.0
- supabase-studio: Supabase Studio

### 13.2 Nginx設定

- ルートディレクトリ: /usr/share/nginx/html
- SPAルーティング: try_files $uri $uri/ /index.html
- 静的ファイルキャッシュ: 1年間（js, css, 画像など）
- Service Worker: /sw.jsはキャッシュ無効
- APIプロキシ: /api/ → http://backend:3000
- WebSocket対応: Upgradeヘッダー設定

### 13.3 ビルドコマンド

- npm run build: 全ビルド
- npm run build:backend: バックエンドのみ
- npm run build:frontend: フロントエンドのみ

### 13.4 開発環境

- npm run dev: フロントエンド・バックエンド同時起動（concurrently使用）
- npm run dev:backend: バックエンドのみ（watchモード）
- npm run dev:frontend: フロントエンドのみ（Vite dev server）

### 13.5 CI/CDパイプライン

#### トリガー
- push: main, developブランチ
- pull_request: mainブランチ

#### ジョブ構成
1. **backend-test**: 
   - PostgreSQL 15サービス起動
   - 依存関係インストール（npm ci）
   - リンティング（npm run lint）
   - テスト実行（npm run test:cov）
   - Codecovへのカバレッジアップロード

2. **frontend-test**:
   - 依存関係インストール（npm ci）
   - リンティング（npm run lint）
   - テスト実行（npm run test:coverage）
   - Codecovへのカバレッジアップロード

3. **security-scan**:
   - Trivy脆弱性スキャン
   - SARIF形式で結果出力
   - GitHub Securityタブにアップロード

4. **build**:
   - 前提条件: backend-test, frontend-test, security-scan成功
   - Docker Buildxセットアップ
   - GitHub Container Registryへのログイン
   - バックエンドイメージのビルド・プッシュ
   - フロントエンドイメージのビルド・プッシュ
   - キャッシュ: GitHub Actions Cache使用

5. **deploy-production**:
   - 前提条件: build成功、mainブランチ
   - 本番環境へのデプロイ（実装は環境に応じてカスタマイズ）

### 13.6 ビルド設定

#### TypeScript設定（バックエンド）
- ターゲット: ES2020
- モジュール: commonjs
- デコレータ: 有効（experimentalDecorators, emitDecoratorMetadata）
- パスエイリアス: @/* → src/*

#### TypeScript設定（フロントエンド）
- プロジェクト参照構成（tsconfig.json + tsconfig.app.json + tsconfig.node.json）
- 厳密な型チェック設定

#### ESLint設定（フロントエンド）
- 拡張: eslint:recommended, @typescript-eslint/recommended, react-hooks/recommended
- ルール: 
  - @typescript-eslint/no-explicit-any: off
  - @typescript-eslint/no-unused-vars: error（_で始まる変数は除外）
  - react-hooks/exhaustive-deps: error

#### Tailwind CSS設定
- コンテンツパス: ./index.html, ./src/**/*.{js,ts,jsx,tsx}
- カスタムアニメーション: fade-in, fade-in-up, float
- フォント: Inter（sans-serif）

## 14. セキュリティ

### 14.1 認証・認可

- JWT認証
- パスワードハッシュ（bcrypt）
- RLS（Row Level Security）

### 14.2 データ保護

- 監査ログ（5年間保持）
- 楽観的ロック（競合防止）
- CORS設定

### 14.3 エラーハンドリング

#### フロントエンドエラーハンドリング
- ErrorBoundary: Reactコンポーネントエラーをキャッチ
  - エラー表示: ユーザーフレンドリーなメッセージ
  - 再試行機能: エラーリセットボタン
  - ログ出力: console.errorでエラー詳細を記録
- ネットワークエラー: 接続エラー時の再試行機能
- バリデーションエラー: フォームフィールド単位でエラー表示

#### バックエンドエラーハンドリング
- 未処理のPromise拒否: unhandledRejectionイベントでキャッチ、ログ記録
- 未処理の例外: uncaughtExceptionイベントでキャッチ、ログ記録
- 致命的エラー: EADDRINUSE（ポート使用中）の場合はプロセス終了
- ログ出力: NestJS Loggerを使用、エラーメッセージとスタックトレースを記録

#### エラーコード標準化

すべてのAPIレスポンスは、エラー発生時に以下のカスタムエラーコードとHTTPステータスコードを返す：

| コード | HTTP Status | エラー名 | 説明 | クライアントの対処 |
|--------|-------------|----------|------|-------------------|
| E-CONFL-001 | 409 Conflict | データ競合エラー | サーバー上のMatches.versionとクライアントのバージョンが不一致。ポイント入力が遅延したか、他の操作と同時に発生した。 | レスポンスボディの最新データを強制採用し、UIを更新する（再同期）。 |
| E-RLS-002 | 403 Forbidden | 権限不足エラー | RLSによってアクセスが拒否された。例: 担当外の試合へのポイント入力、管理者以外の権限付与操作。 | エラーポップアップを表示し、操作をブロック。 |
| E-SYNC-PENDING | 409 Conflict | 同期保留中エラー | クライアントが未同期のオフラインキューを保持したまま、Undo/確定操作を試みた。 | 操作をブロックし、ユーザーに同期完了を待機するよう促すメッセージを表示。 |
| E-VER-003 | 400 Bad Request | データ検証エラー | リクエストペイロードの型、またはビジネスロジック（例: スコアが逆転するなど）の検証に失敗。 | エラーメッセージをユーザーに通知し、修正を促す。 |

#### フロントエンドエラーハンドリング

- ErrorBoundary: Reactコンポーネントエラーをキャッチ
- 競合解決モーダル: E-CONFL-001発生時に表示
- 通知バナー: E-SYNC-PENDING、E-RLS-002発生時に表示
- エラーメッセージ表示: ユーザーフレンドリーなエラーメッセージ

## 15. テスト

### 15.1 テスト環境

- Jest（バックエンド）
- Vitest（フロントエンド）
- Testing Library（React）

### 15.2 テストコマンド

- npm run test: 全テスト
- npm run test:backend: バックエンドのみ
- npm run test:frontend: フロントエンドのみ

## 16. その他

### 16.1 セットアップスクリプト

- setup.sh: 自動セットアップスクリプト
- 依存関係インストール
- 環境変数ファイル作成
- データベースセットアップ

### 16.2 サンプルデータ

- テスト用アカウント（admin, umpire, organizer, manager, player）
- パスワード: testtest（開発環境のみ）

### 16.3 API ドキュメント

- Swagger UI: http://localhost:3000/api/docs
- Bearer認証対応
- 全エンドポイントのリクエスト/レスポンス仕様

### 16.4 DTO（Data Transfer Object）バリデーション

#### 認証DTO
- LoginDto: email（必須、Email形式）、password（必須、最小6文字）

#### 大会DTO
- CreateTournamentDto: name（必須）、description（オプション）、status（オプション、'draft'|'published'|'finished'）、is_public（オプション）、start_date（オプション、DateString）、end_date（オプション、DateString）、match_format（オプション、'team_doubles_3'|'team_doubles_4_singles_1'|'individual_doubles'|'individual_singles'）、created_by_user_id（必須、UUID形式）
- UpdateTournamentDto: 全フィールドオプション

#### 試合DTO
- CreateMatchDto: tournament_id（必須、UUID）、round_name（必須）、umpire_id（オプション）、court_number（オプション）、status（オプション、'pending'|'inprogress'|'finished'）
- UpdateMatchDto: 全フィールドオプション
- AssignMatchDto: court_number（オプション）、umpire_id（オプション）

#### スコアリングDTO
- CreatePointDto: match_id（必須、UUID）、point_type（必須、'A_score'|'B_score'）、client_uuid（必須、UUID）、matchVersion（必須、数値）
- UndoPointDto: match_id（必須、UUID）

#### チームDTO
- CreateTeamDto: name（必須）、school_name（必須）、description（オプション）、team_manager_user_id（必須、UUID）
- UpdateTeamDto: 全フィールドオプション
- CreatePlayerDto: player_name（必須）、player_type（必須、'前衛'|'後衛'）
- UpdatePlayerDto: player_name（オプション）、player_type（オプション、'前衛'|'後衛'）

#### 権限DTO
- AssignRoleDto: user_id（必須、UUID）、tournament_id（必須、UUID）、role（必須、'tournament_admin'|'scorer'）
- RemoveRoleDto: user_id（必須、UUID）、tournament_id（必須、UUID）、role（必須、'tournament_admin'|'scorer'）

### 16.5 ログ機能・監視

#### バックエンドログ
- ログレベル: Logger（NestJS標準）
- ログ出力先: コンソール（本番環境ではCloudWatch等に転送）
- ログ内容:
  - アプリケーション起動・停止
  - エラー発生時のメッセージとスタックトレース
  - 未処理のPromise拒否・例外
- Swagger: API ドキュメント（http://localhost:3000/api/docs）

#### フロントエンドログ
- 開発環境: console.log, console.error
- 本番環境: エラーのみ記録（ErrorBoundary経由）
- エラー追跡: エラーメッセージとスタックトレースを記録

#### 監視（将来実装）
- APIレイテンシ監視: P99レイテンシ300ms超過でアラート
- エラー率監視: 5xxエラー率1%超過でアラート
- DB接続数監視: アクティブコネクション数が許容数の80%で警告

### 16.6 グローバルバリデーション設定

- ValidationPipe: whitelist=true（未定義プロパティを削除）、forbidNonWhitelisted=true（未定義プロパティを拒否）、transform=true（型変換）、enableImplicitConversion=true（暗黙的型変換）

### 16.6 レスポンシブデザイン・モバイル対応

#### デザイン原則（Mobile First）
- ブレイクポイント: sm（640px）以下を最優先
- レイアウト: 主要コンテンツは中央寄せ、max-w-4xl（デスクトップ時）に制限
- フォント: Sans-Serif（Interまたはシステムフォント）
- 操作性: 全てのボタンは44px x 44px以上のタップターゲットを確保
- 配色: メインカラー（青系統）、アクセントカラー（緑・赤）

#### 審判用UI設計方針
- 屋外対応: 直射日光下での視認性を考慮
- 片手操作: スマートフォンでの片手操作を想定
- 年齢層: 6〜60歳まで対応
- 高コントラスト配色: 視認性の高い配色
- 大ボタン: 44x44px以上のボタンサイズ（ファットフィンガー対応）
- 視認性: 大きなフォントサイズ

### 16.7 現場トラブル対応

大会運営中に発生するトラブルに対応するため、以下の機能を提供します。

#### 16.7.1 審判権限の強制上書き機能

**目的**: 審判の不具合やトラブル発生時、管理者が審判権限を強制的に解除・変更できる機能

**機能詳細**:
- **試合割当画面での操作**:
  - 試合割当画面（`/tournaments/:tournamentId/assignments`）から「審判を変更」ボタンで別の審判に再割当
  - 変更確認ダイアログ表示
- **APIエンドポイント**:
  - DELETE /matches/:matchId/umpire - 審判権限の強制解除
  - PUT /matches/:matchId/umpire - 審判の強制変更（別の審判に再割当）
- **権限チェック**:
  - 大会運営者（tournament_admin）のみ実行可能
  - 試合進行中（inprogress）でも強制解除・変更可能
- **影響範囲**:
  - 審判権限解除後、該当試合のスコア入力は一時的に不可
  - 新しい審判を割り当てることで、スコア入力が再開可能
  - 敗者審判モードの場合、審判権限の強制上書きにより自動委譲ロジックを上書き
- **監査ログ**:
  - 審判権限の強制解除・変更は監査ログに記録
  - 操作者、操作日時、対象試合、変更内容を記録

#### 16.7.2 終了試合の差し戻し・スコア修正機能

**目的**: 試合終了後にスコアの誤りが発見された場合、管理者が試合を差し戻してスコアを修正できる機能

**機能詳細**:
- **試合結果画面での操作**:
  - 試合結果画面（`/tournaments/:tournamentId/results`）から、終了した試合を選択
  - 「試合を差し戻す」ボタン（finished試合のみ表示）
  - 差し戻し確認ダイアログ表示（「この操作により、スコアの修正が可能になります。確定済みの試合も差し戻せます」）
- **差し戻し後の状態**:
  - 試合ステータスを`finished`から`inprogress`に変更
  - スコア入力画面から再度スコア修正が可能
  - 確定済み（confirmed）の試合も差し戻し可能
- **APIエンドポイント**:
  - POST /matches/:matchId/revert - 試合を差し戻す（finished → inprogress）
  - PUT /scoring/matches/:matchId/score - スコアの直接修正（管理者権限）
- **権限チェック**:
  - 大会運営者（tournament_admin）のみ実行可能
  - 試合確定後（confirmed）でも差し戻し可能
- **スコア修正方法**:
  - **方法1: スコア入力画面から修正**:
    - 差し戻し後、通常のスコア入力画面（`/scoring/:matchId`）から修正
    - ポイント追加・Undo操作でスコアを調整
  - **方法2: 直接スコア修正**（管理者専用）:
    - 試合結果画面から「スコアを直接修正」ボタン
    - ゲームカウント、現在のスコアを直接入力
    - 確認ダイアログ表示後、スコアを更新
- **影響範囲**:
  - 差し戻し後、該当試合のスコアが変更可能になる
  - 次試合の対戦相手が変更される可能性がある（トーナメント形式の場合）
  - 次試合の審判権限が再計算される（敗者審判モードの場合）
  - 既に次試合が開始されている場合、警告メッセージを表示
- **監査ログ**:
  - 試合の差し戻し、スコアの直接修正は監査ログに記録
  - 操作者、操作日時、対象試合、変更前後のスコアを記録
- **注意事項**:
  - 差し戻し操作は慎重に行う必要がある
  - 次試合が既に開始されている場合、差し戻しは推奨されない（警告表示）
  - 差し戻し後は、次試合の対戦相手を再確認する必要がある
  - 敗者審判モードの場合、差し戻し後の試合終了時に審判権限の自動委譲が再実行される

### 16.8 アクセシビリティ（a11y）

#### ARIA属性
- role属性: dialog, status, alert, region
- aria-label: ボタンや入力フィールドに説明ラベル
- aria-hidden: 装飾的なアイコンに設定
- aria-live: 動的に更新されるコンテンツに設定（polite, assertive）
- aria-expanded: メニューの開閉状態
- aria-controls: コントロール対象の要素ID

#### キーボード操作
- タブナビゲーション: 全インタラクティブ要素にアクセス可能
- キーボードショートカット:
  - Aキー: チームAのポイント追加
  - Bキー: チームBのポイント追加
  - Uキー: Undo操作
- ESCキー: モーダルダイアログを閉じる
- Enter/Space: ボタンのアクティベーション

#### フォーカス管理
- モーダル表示時: 最初のフォーカス可能要素に自動フォーカス
- モーダル閉鎖時: 元のフォーカス位置に戻る
- フォーカス可視化: フォーカスリング（focus:ring-2）を表示

### 16.9 パフォーマンス最適化

#### フロントエンド最適化
- コード分割: React Routerによるルートベースのコード分割
- 画像最適化: WebP形式対応、適切なサイズ
- バンドルサイズ: Tree shaking、未使用コードの削除
- ソースマップ: 本番ビルドでもソースマップ生成（デバッグ用）

#### キャッシュ戦略
- 静的ファイル: 1年間キャッシュ（Nginx設定）
- Service Worker: NetworkFirst戦略（API、Supabase）
- ブラウザキャッシュ: Cache-Controlヘッダーで制御

#### バックエンド最適化
- データベースインデックス: 頻繁にクエリされるカラムにインデックス
- クエリ最適化: N+1問題の回避、JOINの適切な使用
- 接続プール: Supabaseクライアントの接続プール管理

### 16.11 フォームバリデーション（フロントエンド）

#### React Hook Form + Zod
- フォーム管理: React Hook Form 7.48.2
- スキーマバリデーション: Zod 3.22.4
- バリデーションタイミング: onSubmit（送信時）
- エラー表示: フィールド単位でエラーメッセージ表示

#### 主要フォーム
- **ログインフォーム**: 
  - email（必須、Email形式）
  - password（必須、最小6文字）
  - 「パスワードを忘れた場合」リンク
- **サインアップフォーム（SignUpForm）**:
  - display_name（必須）
  - email（必須、Email形式）
  - password（必須、最小6文字）
  - password_confirm（必須、passwordと一致）
  - jsta_number（オプション、JSTA登録番号）
  - **terms_agreed（必須、boolean）**: 利用規約への同意チェックボックス
    - Zodスキーマ: `z.boolean().refine(val => val === true, { message: '利用規約への同意が必要です' })`
    - 利用規約・プライバシーポリシーのリンク表示
    - 同意チェックなしでは送信不可
- **大会作成フォーム**: name（必須）、description（オプション）、status（オプション）、is_public（オプション）
- **チーム作成フォーム**: name（必須）、school_name（必須）、description（オプション）
- **選手登録フォーム**: player_name（必須）、player_type（必須、'前衛'|'後衛'）

### 16.6 ビジネスルール

#### データ整合性
- リアルタイム基盤: Supabase Realtimeを使用し、PostgreSQLの変更をリアルタイムで通知
- オフライン競合解決: サーバー受信時刻（server_received_at）を唯一の正とする
- 排他制御: すべてのスコア入力はサーバー側で排他制御を実施（Matches.version使用）
- 409 Conflictポリシー: 競合時はローカル更新を破棄し、サーバーの最新データを強制採用

#### オフライン操作制限
- 未同期トランザクション（キュー）が存在する場合、Undoおよび試合確定操作はE-SYNC-PENDINGエラーでブロック
- オフライン時はポイント入力のみ許可、Undoや試合確定はオンライン時のみ許可

#### Undo機能の権限
- 試合終了後、結果確定前のUndo権限は大会運営者のみ
- Undo操作はAudit_Logsに詳細な変更履歴と共に記録

#### スコア計算の整合性
- ポイント履歴から常にスコアを再計算（ポイント履歴が唯一の真実の源）
- is_undone=FALSEのポイントのみを計算対象とする
- server_received_atの昇順で処理

## 17. 法務・サポート要件

### 17.1 利用規約・プライバシーポリシー

#### 常設ページ
- **利用規約ページ**: `/terms`（常設、全ユーザーがアクセス可能）
  - 規約の全文表示
  - バージョン管理（規約の更新履歴を保持）
  - 最終更新日時表示
- **プライバシーポリシーページ**: `/privacy`（常設、全ユーザーがアクセス可能）
  - ポリシーの全文表示
  - バージョン管理（ポリシーの更新履歴を保持）
  - 最終更新日時表示

#### サインアップ時の同意フロー
1. サインアップフォームに利用規約・プライバシーポリシーへの同意チェックボックスを表示
2. 規約・ポリシーのリンクをクリックで全文表示（モーダルまたは別ページ）
3. 同意チェックなしではサインアップ不可（Zodバリデーション）
4. 同意時: 同意ログを記録（同意日時、規約バージョン、ポリシーバージョン）

#### 規約更新時の再同意フロー
1. 規約・ポリシー更新時にバージョン番号を更新
2. 次回ログイン時に更新通知を表示
3. 再同意が必要な場合は同意画面を表示（`/consent`）
4. 再同意ログを記録（再同意日時、新規約バージョン）
- **実装状況**: 実装済み
- **規約同意画面**: `/consent`（実装済み）
  - 規約同意状況チェック（APIエンドポイント: GET /auth/consent/check）
  - 再同意フロー（利用規約・プライバシーポリシーへの同意チェックボックス）
  - 同意処理（APIエンドポイント: POST /auth/consent/reagree）
  - バージョン管理機能（環境変数によるバージョン管理）
  - 無限リダイレクト防止（再同意が不要な場合は自動的にダッシュボードへリダイレクト）

### 17.2 ユーザー同意ログ

#### データベーススキーマ（追加推奨）
- **User_Consents（ユーザー同意ログ）**:
  - id: UUID (PK)
  - user_id: UUID (FK → Users, NOT NULL)
  - consent_type: TEXT ('terms' | 'privacy', NOT NULL)
  - version: TEXT (規約・ポリシーのバージョン番号)
  - agreed_at: TIMESTAMPTZ (同意日時, DEFAULT now())
  - ip_address: TEXT (オプション、同意時のIPアドレス)
  - user_agent: TEXT (オプション、同意時のユーザーエージェント)

#### 同意ログの保持
- 同意ログは削除不可（監査目的）
- ユーザーアカウント削除時も同意ログは保持（匿名化は可）

### 17.3 問い合わせ・サポート

#### 問い合わせフォーム
- **パス**: `/support/contact`
- **実装状況**: 実装済み
- **機能**:
  - 問い合わせ種別選択（technical, feature, other）
  - メールアドレス入力（自動入力: ログインユーザーの場合）
  - 件名入力（必須）
  - 本文入力（必須、最小10文字）
  - 送信ボタン
  - データベース保存（contact_requestsテーブル）
  - 送信確認メッセージ表示
  - APIエンドポイント: POST /support/contact

#### ヘルプセンター
- **パス**: `/support/help`
- **実装状況**: 実装済み
- **機能**:
  - FAQ（よくある質問）一覧表示
  - 検索機能（質問・回答内容で検索）
  - カテゴリ別表示（基本操作、スコア入力、ドロー管理、審判、トラブルシューティング）
  - 操作ガイド（将来拡張予定）

### 17.4 アカウント削除（退会）

#### 退会フロー
- **実装状況**: 実装済み
1. 設定画面に「アカウント削除」ボタンを表示
2. 退会確認ダイアログ:
   - 「すべてのデータが削除されます。この操作は取り消せません。」
   - パスワード再入力（セキュリティ確認）
3. 退会処理:
   - Supabase Authからのユーザー削除
   - usersテーブルからの削除（CASCADE削除）
   - 関連データの処理:
     - 作成した大会: CASCADE削除
     - 担当試合: 審判割り当て解除
     - スコア入力履歴: 保持
   - 同意ログ: 保持（匿名化は可）
4. 退会完了通知
- **APIエンドポイント**: DELETE /auth/account

#### データ保持ポリシー
- 監査ログ: 5年間保持（削除不可）
- 同意ログ: 永続保持（削除不可、匿名化は可）
- 大会データ: 大会運営者の判断で保持または削除

## 18. 未実装機能・改善点

### 18.1 未実装機能

1. **分析機能**:
   - Navigation.tsxに「分析」メニューがあるが、comingSoonフラグがついている
   - 分析画面の実装が必要

2. **選手編集画面**:
   - PlayersPageで`/teams/:teamId/players/:playerId/edit`への遷移があるが、このルートが未定義
   - 選手情報の編集画面の実装が必要

3. **エラーページ（404/500）**:
   - Next.jsの`not-found.tsx`と`error.tsx`が未実装
   - 現在は各画面で個別にエラー表示しているが、グローバルなエラーページが必要
   - 404エラーページ: 存在しないURLへのアクセス時の統一的なエラー表示
   - 500エラーページ: サーバーエラー時の統一的なエラー表示
   - エラーページから適切な画面（ダッシュボード、大会一覧など）へのリンク

4. **監査ログ閲覧画面**:
   - `Audit_Logs`テーブルは存在し、RLSポリシーも設定済みだが、閲覧画面が未実装
   - パス: `/admin/audit-logs`（システム管理者のみアクセス可能）
   - 機能:
     - 監査ログ一覧表示（ページネーション対応）
     - フィルター機能: テーブル名、操作種別（INSERT/UPDATE/DELETE）、日付範囲、ユーザー
     - 詳細表示: old_data/new_dataの差分表示（JSONビューアー）
     - エクスポート機能: CSV/JSON形式でのエクスポート
   - APIエンドポイント: GET /api/admin/audit-logs（実装が必要）

5. **ユーザー管理画面（管理者向け）**:
   - `GET /api/auth/users` APIは実装済みだが、フロントエンド画面が未実装
   - パス: `/admin/users`（システム管理者のみアクセス可能）
   - 機能:
     - ユーザー一覧表示（ページネーション対応）
     - 検索機能: ユーザー名、メールアドレスでの検索
     - 権限管理: ユーザー権限の表示・編集
     - アカウント有効化/無効化機能
     - ユーザー詳細表示: 作成日時、最終ログイン日時、関連データ（大会、試合など）

6. **問い合わせ管理画面（管理者向け）**:
   - `Contact_Requests`テーブルは存在し、システム管理者は全問い合わせ参照可能だが、管理画面が未実装
   - パス: `/admin/contact-requests`（システム管理者のみアクセス可能）
   - 機能:
     - 問い合わせ一覧表示（ページネーション対応）
     - フィルター機能: ステータス（pending/resolved）、カテゴリ、日付範囲
     - ステータス管理: pending → resolved への更新
     - 問い合わせ詳細表示: 件名、本文、送信者情報、送信日時
     - 返信機能: メール返信（将来実装）
   - APIエンドポイント: GET /api/admin/contact-requests, PUT /api/admin/contact-requests/:id（実装が必要）

7. **一括操作機能**:
   - 複数試合・エントリーの一括操作機能が未実装
   - **試合割当画面での一括操作**:
     - 複数試合の一括審判割当
     - 複数試合の一括コート番号設定
     - チェックボックスによる複数選択機能
   - **試合結果画面での一括操作**:
     - 複数試合の一括確定
     - 複数試合の一括差し戻し
     - チェックボックスによる複数選択機能
   - **エントリー管理画面での一括操作**:
     - 複数チームの一括削除
     - 複数選手の一括削除
     - 複数ペアの一括削除
     - チェックボックスによる複数選択機能
   - **一括操作の確認ダイアログ**: 操作対象の件数表示、確認メッセージ

### 18.2 改善が必要な機能（TODOコメントあり）

1. **審判名取得**:
   - MatchAssignment.tsxで審判名がnull
   - 改善: umpire_idからUsersテーブルをJOINして審判名を取得

3. **エラー通知コールバック**:
   - offline.tsでエラー通知のコールバックが未実装
   - 改善: エラー発生時の通知機能の実装が必要

### 18.3 機能追加の推奨事項

1. **通知設定の永続化**:
   - 設定画面の通知設定をデータベースに保存
   - ユーザーごとの通知設定を管理

2. **ドロー手動編集機能**:
   - 現在は自動生成のみ
   - 手動で試合の組み合わせを編集できる機能の追加

