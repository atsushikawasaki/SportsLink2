name: è‡ªå‹•ãƒ†ã‚¹ãƒˆä¿®æ­£ã‚µã‚¤ã‚¯ãƒ«

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  automated-test-fix-cycle:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: sportslink-app/package-lock.json

      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        working-directory: ./sportslink-app
        run: npm ci

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨è‡ªå‹•ä¿®æ­£ã‚µã‚¤ã‚¯ãƒ«
        id: test_cycle
        working-directory: ./sportslink-app
        continue-on-error: true
        run: |
          MAX_ITERATIONS=5
          ITERATION=0
          
          while [ $ITERATION -lt $MAX_ITERATIONS ]; do
            ITERATION=$((ITERATION + 1))
            echo "ğŸ”„ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µã‚¤ã‚¯ãƒ« #$ITERATION"
            
            # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            if npm run test > test-output-${ITERATION}.log 2>&1; then
              echo "âœ… ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"
              echo "success=true" >> $GITHUB_OUTPUT
              echo "iteration=$ITERATION" >> $GITHUB_OUTPUT
              break
            else
              TEST_EXIT_CODE=$?
              echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ (çµ‚äº†ã‚³ãƒ¼ãƒ‰: $TEST_EXIT_CODE)"
              
              # ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã‚’è‡ªå‹•ä¿®æ­£
              echo "ğŸ”§ ãƒªãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ã‚’è‡ªå‹•ä¿®æ­£ä¸­..."
              npm run lint -- --fix || true
              
              # ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª
              if grep -q "Cannot find module" test-output-${ITERATION}.log; then
                echo "âš ï¸  ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º"
              fi
              
              if grep -q "SyntaxError" test-output-${ITERATION}.log; then
                echo "âš ï¸  æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º"
              fi
              
              if [ $ITERATION -eq $MAX_ITERATIONS ]; then
                echo "âŒ æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ"
                echo "success=false" >> $GITHUB_OUTPUT
                echo "iteration=$ITERATION" >> $GITHUB_OUTPUT
                break
              fi
              
              echo "â³ æ¬¡ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å¾…æ©Ÿ..."
              sleep 2
            fi
          done

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
        if: always()
        working-directory: ./sportslink-app
        run: |
          echo "## ğŸ§ª è‡ªå‹•ãƒ†ã‚¹ãƒˆä¿®æ­£ã‚µã‚¤ã‚¯ãƒ«çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.test_cycle.outputs.success }}" == "true" ]; then
            echo "âœ… **ãƒ†ã‚¹ãƒˆæˆåŠŸ** (ã‚µã‚¤ã‚¯ãƒ«å›æ•°: ${{ steps.test_cycle.outputs.iteration }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ãƒ†ã‚¹ãƒˆå¤±æ•—** (æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æœ€çµ‚ãƒ†ã‚¹ãƒˆçµæœ" >> $GITHUB_STEP_SUMMARY
          if [ -f test-output-*.log ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 test-output-*.log | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-cycle-results
          path: |
            sportslink-app/test-output-*.log
            sportslink-app/coverage/

      - name: æœ€çµ‚æ¤œè¨¼
        if: steps.test_cycle.outputs.success == 'true'
        working-directory: ./sportslink-app
        run: |
          echo "âœ… æœ€çµ‚æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¾ã™..."
          npm run test
          npm run lint

